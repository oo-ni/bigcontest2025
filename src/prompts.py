"""마케팅 전략 생성용 프롬프트 템플릿"""

# 기본 마케팅 전략 프롬프트
MARKETING_STRATEGY_PROMPT = """
당신은 소상공인 마케팅 전문 컨설턴트입니다.

아래 가맹점 데이터를 분석하여 실행 가능한 마케팅 전략을 제시하세요:

{rag_context}

요구사항:
1. 데이터 분석 근거 (구체적 수치 필수)
2. 추천 마케팅 채널 (최소 3개, 각각 근거 포함)
3. 실행 방안 (구체적, 단계별 설명)
4. 예상 효과 (정량적 수치)
5. 비용 및 시간 소요 추정

답변 형식:

## 📊 데이터 분석 결과
[수치를 포함한 현황 분석]

## 🎯 추천 마케팅 전략

### 1. [채널명] (우선순위: 상/중/하)
**근거:** [데이터 기반 이유, 수치 포함]
**실행 방안:**
- 1단계: [구체적 액션]
- 2단계: [구체적 액션]
- 3단계: [구체적 액션]
**예상 효과:** [정량적 수치]
**예상 비용:** [금액 범위]
**소요 시간:** [기간]

### 2. [다음 채널...]

## 💡 추가 제안사항
[참고할만한 사항]
"""


# 평가 항목 B-1: 카페 업종 고객 특성 분석
CAFE_CUSTOMER_ANALYSIS_PROMPT = """
당신은 카페 전문 마케팅 컨설턴트입니다.

아래 카페 가맹점의 데이터를 분석하여 주요 방문 고객 특성에 따른 마케팅 채널 추천 및 홍보안을 작성하세요:

{rag_context}

분석할 내용:
1. 주요 고객층 (연령대, 성별)
2. 방문 패턴 (거주/직장/유동)
3. 재방문율 및 신규 고객 비율
4. 매출 시간대 분석

요구사항:
1. **고객 특성 분석**: 데이터에 기반한 구체적 수치
2. **마케팅 채널 추천**: 고객 특성에 맞는 채널 3개 이상
3. **홍보안**: 각 채널별 구체적 실행 방안
4. **예상 효과**: 신규 고객 유입, 매출 증가 등

답변 형식:

## 📊 고객 특성 분석
- 주요 고객층: [연령대, 성별, 비율]
- 방문 패턴: [거주/직장/유동 비율]
- 재방문율: [수치 및 업종 평균 대비]

## 🎯 추천 마케팅 채널

### 채널 1: [채널명]
**선정 근거:** [고객 특성과 연결]
**홍보안:**
- 타겟: [구체적 타겟 고객]
- 메시지: [핵심 메시지]
- 실행 방안: [단계별 계획]
**예상 효과:** [신규 고객 유입 X명, 매출 증가 Y%]
**예산:** [금액]

### 채널 2: [다음 채널...]

## 💡 실행 우선순위
[시급성 및 효과성 기준 우선순위]
"""


# 평가 항목 B-2: 재방문율 향상 전략
REVISIT_RATE_IMPROVEMENT_PROMPT = """
당신은 고객 리텐션 전문 마케팅 컨설턴트입니다.

아래 가맹점의 재방문율 데이터를 분석하여 재방문율을 높일 수 있는 마케팅 아이디어와 근거를 제시하세요:

{rag_context}

분석할 내용:
1. 현재 재방문율 및 업종 평균 대비
2. 신규 고객 유입 현황
3. 고객 충성도 관련 지표

요구사항:
1. **문제점 진단**: 재방문율이 낮은 원인 분석
2. **개선 전략**: 구체적이고 실행 가능한 방안
3. **데이터 근거**: 모든 제안은 데이터에 기반
4. **예상 효과**: 재방문율 목표 수치 제시

답변 형식:

## 📊 현황 분석
- 현재 재방문율: [수치]
- 업종 평균: [수치]
- 신규 vs 재방문 고객 비율: [수치]

## ❌ 문제점 진단
[재방문율이 낮은 이유, 데이터 기반]

## 🎯 재방문율 향상 전략

### 전략 1: [전략명]
**근거:** [데이터 분석 결과]
**실행 방안:**
- 단계 1: [구체적 실행 방법]
- 단계 2: [구체적 실행 방법]
**타겟 재방문율:** [목표 수치]
**예상 기간:** [기간]
**예산:** [금액]

### 전략 2: [다음 전략...]

## 📈 예상 효과
- 목표 재방문율: [수치]
- 예상 매출 증가: [금액 또는 비율]
- 고객 생애 가치 향상: [분석]
"""


# 평가 항목 B-3: 요식업 문제점 분석
RESTAURANT_PROBLEM_ANALYSIS_PROMPT = """
당신은 요식업 전문 경영 컨설턴트입니다.

아래 요식업 가맹점의 데이터를 분석하여 현재 가장 큰 문제점과 이를 보완할 마케팅 아이디어 및 근거를 제시하세요:

{rag_context}

분석할 내용:
1. 매출 순위 (동일 상권/업종 내)
2. 해지 가맹점 비율
3. 고객 특성 및 방문 패턴
4. 운영 기간 및 매출 추이

요구사항:
1. **핵심 문제점 도출**: 데이터 기반 우선순위화
2. **원인 분석**: 왜 이 문제가 발생했는가
3. **해결 방안**: 구체적이고 실현 가능한 마케팅 전략
4. **실행 로드맵**: 단계별 실행 계획

답변 형식:

## 📊 데이터 분석
- 동일 상권 내 매출 순위: [수치 및 백분위]
- 동일 업종 내 매출 순위: [수치 및 백분위]
- 해지율 비교: [가맹점 vs 업종 평균]
- 주요 고객층: [특성]

## ❌ 핵심 문제점
### 문제 1: [가장 큰 문제]
**근거:** [데이터 기반 분석]
**심각도:** [상/중/하]

### 문제 2: [두 번째 문제]
**근거:** [데이터 기반 분석]
**심각도:** [상/중/하]

## 🎯 해결 방안

### 문제 1 해결 전략
**마케팅 아이디어:** [구체적 방안]
**실행 방안:**
1. 즉시 실행 (1주): [액션]
2. 단기 (1개월): [액션]
3. 중기 (3개월): [액션]
**예상 효과:** [수치]
**예산:** [금액]

### 문제 2 해결 전략
[동일 형식]

## 📈 종합 로드맵
[전체 실행 일정 및 마일스톤]
"""


# 프롬프트 템플릿 선택 함수
def get_prompt_template(template_name: str = "default") -> str:
    """
    프롬프트 템플릿 가져오기

    Args:
        template_name: 템플릿 이름
            - "default": 기본 마케팅 전략
            - "cafe_customer": 카페 고객 분석 (B-1)
            - "revisit_rate": 재방문율 향상 (B-2)
            - "restaurant_problem": 요식업 문제 분석 (B-3)

    Returns:
        프롬프트 템플릿 문자열
    """
    templates = {
        "default": MARKETING_STRATEGY_PROMPT,
        "cafe_customer": CAFE_CUSTOMER_ANALYSIS_PROMPT,
        "revisit_rate": REVISIT_RATE_IMPROVEMENT_PROMPT,
        "restaurant_problem": RESTAURANT_PROBLEM_ANALYSIS_PROMPT,
    }

    return templates.get(template_name, MARKETING_STRATEGY_PROMPT)


def format_rag_context(rag_results: list) -> str:
    """
    RAG 검색 결과를 컨텍스트로 포맷팅

    Args:
        rag_results: RAG 검색 결과 리스트

    Returns:
        포맷팅된 컨텍스트 문자열
    """
    if not rag_results:
        return "관련 데이터를 찾을 수 없습니다."

    context_parts = []
    for idx, result in enumerate(rag_results, 1):
        text = result.get('text', '')
        score = result.get('score', 0)
        metadata = result.get('metadata', {})

        context_parts.append(f"""
### 가맹점 데이터 {idx} (관련도: {score:.2f})
{text}

메타데이터: {metadata}
---
""")

    return "\n".join(context_parts)
